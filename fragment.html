<!-- Soldering Iron Controller - Embeddable Version -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<style>
	/* .soldering-iron-app {
		font-family: Arial, sans-serif;
		max-width: 800px;
		margin: 0 auto;
		padding: 20px;
		background-color: #f5f5f5;
	}

	.soldering-iron-app .container {
		background-color: white;
		padding: 20px;
		border-radius: 8px;
		box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
		margin-bottom: 20px;
	}

	.soldering-iron-app h1,
	.soldering-iron-app h2 {
		color: #333;
	} */

	.soldering-iron-app .status {
		padding: 10px;
		margin: 10px 0;
		border-radius: 4px;
	}

	.soldering-iron-app .status.connected {
		background-color: #d4edda;
		color: #155724;
		border: 1px solid #c3e6cb;
	}

	.soldering-iron-app .status.disconnected {
		background-color: #f8d7da;
		color: #721c24;
		border: 1px solid #f5c6cb;
	}

	.soldering-iron-app .controls {
		display: flex;
		gap: 10px;
		align-items: center;
		margin: 10px 0;
	}

	.soldering-iron-app button {
		padding: 8px 16px;
		background-color: #007bff;
		color: white;
		border: none;
		border-radius: 4px;
		cursor: pointer;
	}

	.soldering-iron-app button:hover {
		background-color: #0056b3;
	}

	.soldering-iron-app button:disabled {
		background-color: #6c757d;
		cursor: not-allowed;
	}

	.soldering-iron-app input[type="range"] {
		width: 200px;
	}

	.soldering-iron-app input[type="number"] {
		width: 80px;
		padding: 4px;
		border: 1px solid #ccc;
		border-radius: 4px;
	}

	.soldering-iron-app .settings-grid {
		display: grid;
		grid-template-columns: 1fr 1fr;
		gap: 20px;
	}

	.soldering-iron-app .setting-item {
		display: flex;
		justify-content: space-between;
		align-items: center;
		padding: 8px 0;
		border-bottom: 1px solid #eee;
	}

	.soldering-iron-app .log {
		background-color: #f8f9fa;
		border: 1px solid #dee2e6;
		border-radius: 4px;
		padding: 10px;
		height: 200px;
		overflow-y: auto;
		font-family: monospace;
		font-size: 12px;
	}
</style>

<div class="soldering-iron-app">
	<h1>Soldering Iron Controller</h1>

	<!-- Connection Status -->
	<div class="container">
		<h2>Connection</h2>
		<div id="connectionStatus" class="status disconnected">Disconnected</div>
		<div class="controls">
			<button id="connectBtn">Connect to Device</button>
			<button id="disconnectBtn" disabled>Disconnect</button>
		</div>
	</div>

	<!-- Live Status Display -->
	<div class="container">
		<h2>Device Status</h2>
		<div id="deviceStatus">
			<div><strong>Temperature:</strong> <span id="currentTemp">--</span>°C</div>
			<div><strong>Target Temperature:</strong> <span id="targetTemp">--</span>°C</div>
			<div><strong>Heating:</strong> <span id="heatingStatus">--</span></div>
			<div><strong>Power:</strong> <span id="powerLevel">--</span>%</div>
		</div>
	</div>

	<!-- Temperature Control -->
	<div class="container">
		<h2>Temperature Control</h2>
		<div class="controls">
			<label for="tempSlider">Target Temperature:</label>
			<input type="range" id="tempSlider" min="150" max="450" value="300" step="5">
			<input type="number" id="tempInput" min="150" max="450" value="300" step="5">
			<span>°C</span>
			<button id="setTempBtn" disabled>Set Temperature</button>
		</div>
		<div class="controls">
			<button id="standbyBtn" disabled>Standby (150°C)</button>
			<button id="workBtn" disabled>Work (350°C)</button>
			<button id="maxBtn" disabled>Max (450°C)</button>
		</div>
	</div>

	<!-- Device Settings -->
	<div class="container">
		<h2>Device Settings</h2>
		<div class="settings-grid">
			<div>
				<h3>Temperature Settings</h3>
				<div class="setting-item">
					<label for="standbyTemp">Standby Temperature:</label>
					<input type="number" id="standbyTemp" min="100" max="200" value="150">
				</div>
				<div class="setting-item">
					<label for="workTemp">Work Temperature:</label>
					<input type="number" id="workTemp" min="200" max="400" value="350">
				</div>
				<div class="setting-item">
					<label for="maxTemp">Max Temperature:</label>
					<input type="number" id="maxTemp" min="300" max="450" value="450">
				</div>
			</div>
			<div>
				<h3>Other Settings</h3>
				<div class="setting-item">
					<label for="autoOff">Auto-off (minutes):</label>
					<input type="number" id="autoOff" min="0" max="60" value="30">
				</div>
				<div class="setting-item">
					<label for="beepEnabled">Beep Enabled:</label>
					<input type="checkbox" id="beepEnabled" checked>
				</div>
				<div class="setting-item">
					<label for="displayBrightness">Display Brightness:</label>
					<input type="range" id="displayBrightness" min="1" max="10" value="7">
				</div>
			</div>
		</div>
		<div class="controls">
			<button id="saveSettingsBtn" disabled>Save Settings</button>
			<button id="loadSettingsBtn" disabled>Load Settings</button>
			<button id="resetSettingsBtn" disabled>Reset to Defaults</button>
		</div>
	</div>

	<!-- Communication Log -->
	<div class="container">
		<h2>Communication Log</h2>
		<div id="commLog" class="log"></div>
		<div class="controls">
			<button id="clearLogBtn">Clear Log</button>
		</div>
	</div>
</div>

<script>
	let serialPort = null;
	let writer = null;
	let reader = null;
	let isConnected = false;
	let statusUpdateInterval = null;
	let readBuffer = ''; // Buffer for incomplete JSON responses

	// Initialize the application
	$(document).ready(function () {
		initializeEventHandlers();
		updateConnectionStatus(false);
	});

	function initializeEventHandlers() {
		// Connection controls
		$('#connectBtn').click(connectToDevice);
		$('#disconnectBtn').click(disconnectFromDevice);

		// Temperature controls
		$('#tempSlider').on('input', function () {
			$('#tempInput').val($(this).val());
		});
		$('#tempInput').on('input', function () {
			$('#tempSlider').val($(this).val());
		});
		$('#setTempBtn').click(setTemperature);
		$('#standbyBtn').click(() => setQuickTemp(150));
		$('#workBtn').click(() => setQuickTemp(350));
		$('#maxBtn').click(() => setQuickTemp(450));

		// Settings controls
		$('#saveSettingsBtn').click(saveSettings);
		$('#loadSettingsBtn').click(loadSettings);
		$('#resetSettingsBtn').click(resetSettings);

		// Log controls
		$('#clearLogBtn').click(clearLog);
	}

	async function connectToDevice() {
		try {
			if (!('serial' in navigator)) {
				logMessage('Web Serial API not supported in this browser');
				return;
			}

			// Request port with specific VID and PID filters
			serialPort = await navigator.serial.requestPort({
				filters: [
					{
						usbVendorId: 0x2E8A,
						usbProductId: 0x000A
					}
				]
			});
			await serialPort.open({ baudRate: 115200 });

			writer = serialPort.writable.getWriter();
			reader = serialPort.readable.getReader();

			isConnected = true;
			updateConnectionStatus(true);
			startStatusUpdates();

			logMessage('Connected to device');

			// Send initial status request
			sendCommand({ action: 'status_get' });

		} catch (error) {
			logMessage('Connection failed: ' + error.message);
			updateConnectionStatus(false);
		}
	}

	async function disconnectFromDevice() {
		try {
			if (statusUpdateInterval) {
				clearInterval(statusUpdateInterval);
				statusUpdateInterval = null;
			}

			if (reader) {
				await reader.releaseLock();
				reader = null;
			}

			if (writer) {
				await writer.releaseLock();
				writer = null;
			}

			if (serialPort) {
				await serialPort.close();
				serialPort = null;
			}

			isConnected = false;
			readBuffer = ''; // Clear the read buffer
			updateConnectionStatus(false);
			logMessage('Disconnected from device');

		} catch (error) {
			logMessage('Disconnect error: ' + error.message);
		}
	}

	function updateConnectionStatus(connected) {
		const statusDiv = $('#connectionStatus');
		const connectBtn = $('#connectBtn');
		const disconnectBtn = $('#disconnectBtn');

		if (connected) {
			statusDiv.removeClass('disconnected').addClass('connected').text('Connected');
			connectBtn.prop('disabled', true);
			disconnectBtn.prop('disabled', false);
			enableControls(true);
		} else {
			statusDiv.removeClass('connected').addClass('disconnected').text('Disconnected');
			connectBtn.prop('disabled', false);
			disconnectBtn.prop('disabled', true);
			enableControls(false);
		}
	}

	function enableControls(enabled) {
		$('#setTempBtn, #standbyBtn, #workBtn, #maxBtn, #saveSettingsBtn, #loadSettingsBtn, #resetSettingsBtn')
			.prop('disabled', !enabled);
	}

	async function sendCommand(command) {
		if (!isConnected || !writer) {
			logMessage('Not connected to device');
			return;
		}

		try {
			const commandStr = JSON.stringify(command) + '\r\n';
			const encoder = new TextEncoder();
			await writer.write(encoder.encode(commandStr));
			logMessage('Sent: ' + commandStr.trim());
		} catch (error) {
			logMessage('Send error: ' + error.message);
		}
	}

	async function readResponse() {
		if (!reader) return;

		try {
			const { value, done } = await reader.read();
			if (done) return;

			const decoder = new TextDecoder();
			const newData = decoder.decode(value);

			// Add new data to buffer
			readBuffer += newData;

			// Process all complete JSON objects (separated by \r\n)
			let startIndex = 0;
			while (true) {
				const endIndex = readBuffer.indexOf('\r\n', startIndex);
				if (endIndex === -1) {
					// No complete line found, keep remaining data in buffer
					readBuffer = readBuffer.substring(startIndex);
					break;
				}

				const line = readBuffer.substring(startIndex, endIndex).trim();
				if (line) {
					logMessage('Received: ' + line);

					// Try to parse as JSON
					try {
						const data = JSON.parse(line);
						handleResponse(data);
					} catch (e) {
						// Handle non-JSON responses
						logMessage('Non-JSON response: ' + line);
					}
				}

				startIndex = endIndex + 2; // Skip \r\n
			}
		} catch (error) {
			logMessage('Read error: ' + error.message);
		}
	}

	function handleResponse(data) {
		if (data.status) {
			updateDeviceStatus(data.status);
		}
		if (data.settings) {
			updateSettingsDisplay(data.settings);
		}
	}

	function updateDeviceStatus(status) {
		if (status.temperature !== undefined) {
			$('#currentTemp').text(status.temperature);
		}
		if (status.target_temperature !== undefined) {
			$('#targetTemp').text(status.target_temperature);
		}
		if (status.heating !== undefined) {
			$('#heatingStatus').text(status.heating ? 'Yes' : 'No');
		}
		if (status.power !== undefined) {
			$('#powerLevel').text(status.power);
		}
	}

	function updateSettingsDisplay(settings) {
		if (settings.standby_temp !== undefined) {
			$('#standbyTemp').val(settings.standby_temp);
		}
		if (settings.work_temp !== undefined) {
			$('#workTemp').val(settings.work_temp);
		}
		if (settings.max_temp !== undefined) {
			$('#maxTemp').val(settings.max_temp);
		}
		if (settings.auto_off !== undefined) {
			$('#autoOff').val(settings.auto_off);
		}
		if (settings.beep_enabled !== undefined) {
			$('#beepEnabled').prop('checked', settings.beep_enabled);
		}
		if (settings.display_brightness !== undefined) {
			$('#displayBrightness').val(settings.display_brightness);
		}
	}

	function startStatusUpdates() {
		if (statusUpdateInterval) {
			clearInterval(statusUpdateInterval);
		}

		statusUpdateInterval = setInterval(async () => {
			if (isConnected) {
				await sendCommand({ action: 'status_get' });
				await readResponse();
			}
		}, 1000); // Update every second
	}

	async function setTemperature() {
		const temp = parseInt($('#tempInput').val());
		if (temp >= 150 && temp <= 450) {
			await sendCommand({ action: 'temperature_target_set', temperature: temp });
		}
	}

	async function setQuickTemp(temp) {
		$('#tempInput').val(temp);
		$('#tempSlider').val(temp);
		await sendCommand({ action: 'temperature_target_set', temperature: temp });
	}

	async function saveSettings() {
		const settings = {
			action: 'settings_save',
			standby_temp: parseInt($('#standbyTemp').val()),
			work_temp: parseInt($('#workTemp').val()),
			max_temp: parseInt($('#maxTemp').val()),
			auto_off: parseInt($('#autoOff').val()),
			beep_enabled: $('#beepEnabled').is(':checked'),
			display_brightness: parseInt($('#displayBrightness').val())
		};
		await sendCommand(settings);
	}

	async function loadSettings() {
		await sendCommand({ action: 'settings_load' });
	}

	async function resetSettings() {
		if (confirm('Reset all settings to defaults?')) {
			await sendCommand({ action: 'settings_reset' });
		}
	}

	function logMessage(message) {
		const timestamp = new Date().toLocaleTimeString();
		$('#commLog').append(`[${timestamp}] ${message}<br/>`);
		$('#commLog').scrollTop($('#commLog')[0].scrollHeight);
	}

	function clearLog() {
		$('#commLog').empty();
	}
</script>